---
title: "scRNAseq_pipeline"
output: pdf_document
params:
  output: "default_output" 
  config_path: "default_config_path" 
---

# ENVIRONMENT SETUP

```{r env, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE)
library(reticulate)
library(future)
library(future.apply)
library(furrr)
library(purrr)
library(dplyr)
library(Seurat)
library(patchwork)
library(scran)
library(BiocParallel)
library(DropletUtils)
library(cowplot)
library(harmony)
library(SoupX)
library(scDblFinder)
library(jsonlite)
library(rmarkdown)
library(tidyverse)
library(tibble)
library(stringr)
library(clustifyr)
library(scry)
library(ggplot2)
library(ComplexHeatmap)

# Set up parallel processing
# Reduce number of workers and increase per-worker memory
options(future.globals.maxSize = 50000 * 1024^2)  # 50GB
plan(multisession, workers = 4)  # Reduce from 64 to 4 workers

# Python setup
py_config()
cat("Available conda environments:\n")
conda_list()
python_path <- system("which python3", intern=TRUE)
cat("Python path:", python_path, "\n")
use_python(python_path, required = TRUE)

# Load configuration
output <- params$output
config <- jsonlite::fromJSON(params$config_path, simplifyDataFrame = FALSE)
output_base_dir <- paste0("../", output, "/")
source("sc_pipeline_functions.R")
source("process_lane.R")

```
```{r process_lane}

# Process lanes in parallel
processed_data_list <- future_lapply(config$lanes, process_lane)
```
```{r prcoess_sample}
# Parallel mapping for seurat and sce lists
seurat_list <- future_map(processed_data_list, "seu")
sce_list <- future_map(processed_data_list, "sce")

feature_set <- list(feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
combine_feature_plots(seurat_list, output_base_dir, feature_set, file_name_base = "post_soupx_qc")

sample_specific_sce_list <- split_sce_list_by_sample(sce_list)
#clean_environment(list_to_remove = c("processed_data_list", "seurat_list", "feature_set"))

# Process samples and store results
processed_samples_list <- lapply(names(sample_specific_sce_list), function(sample_name) {
  message(paste("Processing sample:", sample_name))
  sample_data <- sample_specific_sce_list[[sample_name]]
  result <- process_sample(sample_name, sample_data, output_base_dir, config)
  
  # Add some error checking
  if (is.null(result)) {
    warning(paste("No results returned for sample:", sample_name))
    return(NULL)
  }
  
  return(result)
})

# Name the list elements
names(processed_samples_list) <- names(sample_specific_sce_list)

# Remove any NULL entries
processed_samples_list <- Filter(Negate(is.null), processed_samples_list)

# Save the processed Seurat objects
if (length(processed_samples_list) > 0) {
  saveRDS(processed_samples_list, file = paste0(output_base_dir, "processed_seurat_objects.rds"))
  message("Successfully saved processed samples list")
} else {
  warning("No processed samples to save!")
}
```
```{r}
# Do cross species
if (!species_are_all_same(config)) {
  message("Starting cross-species analysis...")
  objs_list <- perform_orthologous_gene_analysis(processed_samples_list, config, output_base_dir)
  
  if (!is.null(objs_list)) {
    sample_names <- names(objs_list)
    if (length(sample_names) >= 2) {
      ref_name <- sample_names[1]
      query_name <- sample_names[2]
      
      message(paste("Processing reference:", ref_name))
      ref_list <- process_orthologous_objects(objs_list[[ref_name]], output_base_dir, config, ref_name)
      
      message(paste("Processing query:", query_name))
      query_list <- process_orthologous_objects(objs_list[[query_name]], output_base_dir, config, query_name)
    } else {
      warning("Insufficient samples for cross-species analysis")
    }
  } else {
    warning("No objects returned from orthologous gene analysis")
  }
}
```


