---
title: "Your Title"
output: html_document
---

# ENVIRONMENT SETUP

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(Seurat)
library(patchwork)
library(scran)
library(BiocParallel)
library(DropletUtils)
library(cowplot)
library(harmony)
library(SoupX)
library(scDblFinder)
library(reticulate)
# SET WD TO THE DIRECTORY WHERE THE SCRIPT IS LOCATED
# IMPLEMENT WAY TO AUTOFILL CONDA NAME AND PATH TO CONDA BINARY VIA INSTALL SCRIPT
use_condaenv("TESTv7", conda = "/isiseqruns/jfreeman_tmp_home/bin/miniconda3/condabin/conda")
setwd("/isiseqruns/jfreeman_tmp_home/GAMM/scRNAseq_library/")
source("src/sc_pipeline_functions.R")

```
# Load Data


```{r}
data <- read_aligned_data(
  "/w5home/bmoore/scRNAseq/GAMM/output_S1-1_mm_mt/Solo.out/GeneFull/filtered/")
raw_data <- read_aligned_data(
  "/w5home/bmoore/scRNAseq/GAMM/output_S1-1_mm_mt/Solo.out/GeneFull/raw/")
project <- "gamm_s1-1"

data_2 <- read_aligned_data(
  "/w5home/bmoore/scRNAseq/GAMM/output_S1-2_mm_mt/Solo.out/GeneFull/filtered/")
raw_data_2 <- read_aligned_data(
  "/w5home/bmoore/scRNAseq/GAMM/output_S1-2_mm_mt/Solo.out/GeneFull/raw/")
project_2 <- "gamm_s1-2"
```

# Data Prep


```{r}
soupX_objs1 <- prep_seurat_and_soupX(
  data = data, data.raw = raw_data, project = project)

soupX_objs2 <- prep_seurat_and_soupX(
  data = data_2, data.raw = raw_data_2, project = project_2)
```

# Create Seurat objects and convert to sce objects


```{r}
filtered_list_of_objs <- create_seurat_and_sce(
  soupX_objs1$out, soupX_objs2$out)
```


# Post SoupX QC


```{r}
plot1 <- create_feature_scatter_plot(filtered_list_of_objs$gamm1_seu, 'nCount_RNA', 'nFeature_RNA')
plot2 <- create_feature_scatter_plot(filtered_list_of_objs$gamm2_seu, 'nCount_RNA', 'nFeature_RNA')
# save plot object as a pdf 
  pdf(paste0("plot_outputs/post_SoupX_plot.pdf"), width = 8, height = 6)
  plot1 + plot2
dev.off()
```


# Doublet removal and lane merging


```{r}
lane_and_merged_gamm <- run_scDblFinder_and_merge(
  filtered_list_of_objs$sce1, filtered_list_of_objs$sce2)

dbl_table1 <- as.data.frame(lane_and_merged_gamm$table1)
dbl_table2 <- as.data.frame(lane_and_merged_gamm$table2)
```

# Post Doublet removal QC


```{r}
plot <- create_feature_scatter_plot(lane_and_merged_gamm$gamm, 'nCount_RNA', 'nFeature_RNA')
  pdf(paste0("plot_outputs/after_dbl_removal.pdf"), width = 8, height = 6)
  plot
dev.off()
```

# Mitochondrial gene filtering
## Defaults = lower.nFeature = 200, upper.nFeature = 8000, max.percent.mt = 5

```{r}
# TODO: add option for human mt lists 
pig_mt_list <- c("ND1","ND2", "COX1", "COX2", "ATP8", "ATP6", "COX3", "ND3", "ND4L", "ND4", "ND5", "ND6", "CYTB")
gamm_mt_filtered <- filter_cells(lane_and_merged_gamm$gamm, pig_mt_list)
plot1 <- create_feature_scatter_plot(gamm_mt_filtered$gamm, 'nCount_RNA', 'percent.mt')
plot2 <- create_feature_scatter_plot(gamm_mt_filtered$gamm, 'nCount_RNA', 'nFeature_RNA')

  pdf(paste0("plot_outputs/mt_filtered.pdf"), width = 8, height = 6)
  plot1 + plot2
dev.off()
  pdf(paste0("plot_outputs/mt_unfiltered.pdf"), width = 8, height = 6)
  gamm_mt_filtered$pre_filter_plot
dev.off()
```

# Normalization
```{r}
normalized_gamm <- normalize_data(gamm_mt_filtered$gamm)
```

# Post Normalization QC (violin plots)
```{r}
vin_pre <- VlnPlot(normalized_gamm, "ECHS1", slot = "counts")
vin_post <- VlnPlot(normalized_gamm, "ECHS1", slot = "data")
  pdf(paste0("plot_outputs/violin_pre_norm.pdf"), width = 8, height = 6)
  vin_pre
dev.off()
  pdf(paste0("plot_outputs/violin_post_norm.pdf"), width = 8, height = 6)
  vin_post
dev.off()
```


# Feature selection

```{r}
# analysis_type = 'Scry' or 'Seurat'
feature_selected_gamm <- feature_selection(normalized_gamm, 'Scry')
```


# Scaling data

```{r}
# TODO add option for regressing out cell cell cycle genes
scaled_gamm <- scale_data(feature_selected_gamm)
```

# Dimensional reduction

```{r}
pca_outputs <- run_and_visualize_pca(scaled_gamm)

pdf(paste0("plot_outputs/feature_loadings.pdf"), width = 8, height = 6)
pca_outputs$feature_loadings
dev.off()

pdf(paste0("plot_outputs/pca_scatter_plot.pdf"), width = 8, height = 6)
pca_outputs$pca_scat_plot
dev.off()

pdf(paste0("plot_outputs/pca_heat_map.pdf"), width = 8, height = 6)
pca_outputs$pca_heat_map
dev.off()

seurat_obj <- pca_outputs$seurat_obj
```

# Batch correction
```{r}
batch_corrected_obj_and_plots <- perform_batch_correction(seurat_obj)
pdf(paste0("plot_outputs/batch_uncorrected_pca.pdf"), width = 8, height = 6)
batch_corrected_obj_and_plots$p1_pre + batch_corrected_obj_and_plots$p2_pre
dev.off()
pdf(paste0("plot_outputs/batch_corrected_pca.pdf"), width = 8, height = 6)
batch_corrected_obj_and_plots$p1_post + batch_corrected_obj_and_plots$p2_post
dev.off()
```

# Clustering 
```{r}
# Defaults: num.replicate = 100, dims = 1:20, dims_umap = 1:15, resolution = 0.5
clustered_seurat_obj <- perform_clustering(batch_corrected_obj_and_plots$seurat_obj)
pdf(paste0("plot_outputs/elbow_harmony.pdf"), width = 8, height = 6)
clustered_seurat_obj$elbow_harm
dev.off()
pdf(paste0("plot_outputs/elbow_pca.pdf"), width = 8, height = 6)
clustered_seurat_obj$elbow_pca
dev.off()
pdf(paste0("plot_outputs/jack_straw.pdf"), width = 8, height = 6)
clustered_seurat_obj$jack_straw
dev.off()
pdf(paste0("plot_outputs/umap_lanes.pdf"), width = 8, height = 6)
clustered_seurat_obj$umap_lanes
dev.off()
pdf(paste0("plot_outputs/umap_clusters.pdf"), width = 8, height = 6)
clustered_seurat_obj$umap_clusters
dev.off()
```

# SAVE WORK
```{r}
saveRDS(clustered_seurat_obj$seurat_obj, file = "output/clustered_seurat_obj.rds")
writeLines(capture.output(sessionInfo()), "output/session_info.txt")
# save session info as a text file


```


```{r}
final_objs <- find_differential_expression(reduced_clustered_seurat_obj$seurat_obj)
```




