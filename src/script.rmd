---
title: "Your Title"
output: html_document
---

# ENVIRONMENT SETUP

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(Seurat)
library(patchwork)
library(scran)
library(BiocParallel)
library(DropletUtils)
library(cowplot)
library(harmony)
library(SoupX)
library(scDblFinder)
library(reticulate)
library(purrr)
library(jsonlite)
use_condaenv("PIPELINE_1.03", conda = "/isiseqruns/jfreeman_tmp_home/bin/miniconda3/condabin/conda")
setwd("/isiseqruns/jfreeman_tmp_home/GAMM/scRNAseq_library")
output <- "output"
dir.create(output, showWarnings = FALSE)
config <- fromJSON("config.json")
source("src/sc_pipeline_functions.R")
```

# Load Data
```{r}
project_s1_1 <- read_aligned_data("/w5home/bmoore/scRNAseq/GAMM/output_S1-1_mm_mt/Solo.out/GeneFull", "gamm_s1-1")
project_s1_2 <- read_aligned_data("/w5home/bmoore/scRNAseq/GAMM/output_S1-2_mm_mt/Solo.out/GeneFull", "gamm_s1-2")
all_aligned_data <- list(project_s1_1, project_s1_2)
```

# Data Prep
```{r}
soupX_objs <- purrr::map(all_aligned_data, ~prep_seurat_and_soupX(data.raw = .x$raw, data = .x$filtered, project = .x$project), .names = purrr::map_chr(all_data, 'project'))
```

# Create Seurat objects and convert to sce objects
```{r}
project_names <- purrr::map_chr(all_aligned_data, 'project')
feature_set1 <- list(feature1 = 'nCount_RNA', feature2 = 'nFeature_RNA')
filtered_list_of_objs <- purrr::map2(soupX_objs, project_names, ~create_seurat_and_sce(out = .x$out, project = .y, feature_set = feature_set1))

```

# Doublet removal and lane merging
```{r}
combine_feature_plots(filtered_list_of_objs, feature_set1, file_name_base = "post_soupx_qc")
filtered_sce_list <- list(filtered_list_of_objs[[1]]$sce, filtered_list_of_objs[[2]]$sce)
lane_and_merged_seurat_obj <- run_scDblFinder_and_merge(filtered_sce_list)
```

# Mitochondrial gene filtering
```{r}
pig_mt_list <- c("ND1","ND2", "COX1", "COX2", "ATP8", "ATP6", "COX3", "ND3", "ND4L", "ND4", "ND5", "ND6", "CYTB")
seurat_obj_mt_filtered <- filter_cells(lane_and_merged_seurat_obj$seurat_obj, mt.list = pig_mt_list)
```

# Normalization
```{r}
normalized_seurat_obj <- normalize_data(seurat_obj_mt_filtered)
```

# Feature selection
```{r}
feature_selected_seurat_obj <- feature_selection(normalized_seurat_obj)
```

# Scaling data
```{r}
# TODO: add option for regressing out cell cell cycle genes
scaled_seurat_obj <- scale_data(feature_selected_seurat_obj)
```

# Dimensional reduction
```{r}
dim_reduced_seurat_obj <- run_and_visualize_pca(scaled_seurat_obj)
```

# Batch correction
```{r}
batch_corrected_obj <- perform_batch_correction(dim_reduced_seurat_obj)
```

# Clustering 
```{r}
clustered_seurat_obj <- perform_clustering(batch_corrected_obj$seurat_obj)
```

# Differential expression
```{r}
de_results <- find_differentially_expressed_features(clustered_seurat_obj)
```

# Analyze Known Markers
```{r}
analyze_known_markers(de_results, clustered_seurat_obj)
```

# Score and plot Markers
```{r}
score_and_plot_markers(de_results, clustered_seurat_obj)
```

# Annotate clusters and save
```{r}
new_cluster_ids <- c("Retinal Prog-Muller glia-1","Pan PR-Synaptic-Neuronal proj", 
                    "Pan PR-Synaptic-Neuronal proj-Rod-1","Pan PR-Rod-Neuronal proj-1",
                    "Pan PR-Rod-Neuronal proj-2","Pan PR-Synaptic-Neuronal proj-Rod-2",
                    "mix1","Bipolar cells fetal-Synaptic-1","Pan PR-Rod-Neuronal proj-3",
                    "Phototransduction?","Phototransduction?-PanPR","Cone-PanPR-Neuronal proj-Ganglion cell(fetal)",
                    "mix2","Retinal Progenitor","Muller glia-Retinal prog-Rod-PanPR","Retinal Prog-Muller glia-2",
                    "Retinal Prog-Muller glia-3","Bipolar cells fetal-Synaptic-2")

seurat_obj <- annotate_clusters_and_save(seurat_obj, new_cluster_ids, output_file = "GAMM_S2_labeled-clusters.rds")
```
